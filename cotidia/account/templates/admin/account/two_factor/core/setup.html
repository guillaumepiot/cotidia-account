{% extends "admin/account/base.html" %}
{% load i18n %}

{% block title %}{% trans "Enable Two-Factor Authentication" %}{% endblock %}

{% block main %}
<form method="post" action=".">
    {% csrf_token %}
    <div class="dialog dialog--small">
        <div class="dialog__content dialog__content--small">
            {% block dialog_header %}
                {% include "admin/account/includes/dialog_header.html" %}
            {% endblock %}
            <div class="dialog__body dialog__body--padded">
                {% include "admin/includes/messages.html" %}
                <h3>{% trans "Enable Two-Factor Authentication" %}</h3>
                {% if wizard.steps.current == 'welcome' %}
                    <p>{% blocktrans %}You are about to take your account security to the
                    next level. Follow the steps in this wizard to enable two-factor
                    authentication.{% endblocktrans %}</p>
                    {% elif wizard.steps.current == 'method' %}
                    <p>{% blocktrans %}Please select which authentication method you would
                    like to use.{% endblocktrans %}</p>
                {% elif wizard.steps.current == 'generator' %}
                    <p>{% blocktrans %}To start using a token generator, please use your
                    smartphone to scan the QR code below. For example, use Google
                    Authenticator. Then, enter the token generated by the app.
                    {% endblocktrans %}</p>
                    <p><img src="{{ QR_URL }}" alt="QR Code" /></p>
                {% elif wizard.steps.current == 'sms' %}
                    <p>{% blocktrans %}Please enter the phone number you wish to receive the
                    text messages on. This number will be validated in the next step.
                    {% endblocktrans %}</p>
                {% elif wizard.steps.current == 'call' %}
                    <p>{% blocktrans %}Please enter the phone number you wish to be called on.
                    This number will be validated in the next step. {% endblocktrans %}</p>
                {% elif wizard.steps.current == 'validation' %}
                    {% if challenge_succeeded %}
                        {% if device.method == 'call' %}
                            <p>{% blocktrans %}We are calling your phone right now, please enter the
                              digits you hear.{% endblocktrans %}</p>
                            {% elif device.method == 'sms' %}
                            <p>{% blocktrans %}We sent you a text message, please enter the tokens we
                              sent.{% endblocktrans %}</p>
                        {% endif %}
                    {% else %}
                        <p class="alert alert--warning" role="alert">{% blocktrans %}We've
                        encountered an issue with the selected authentication method. Please
                        go back and verify that you entered your information correctly, try
                        again, or use a different authentication method instead. If the issue
                        persists, contact the site administrator.{% endblocktrans %}</p>
                    {% endif %}
                {% elif wizard.steps.current == 'yubikey' %}
                    <p>{% blocktrans %}To identify and verify your YubiKey, please insert a
                    token in the field below. Your YubiKey will be linked to your
                    account.{% endblocktrans %}</p>
                {% endif %}

                {% if form.non_field_errors %}
                    <div class="alert alert--error">
                    {% for error in form.non_field_errors %}
                        {{error}}<br>
                    {% endfor %}
                    </div>
                {% endif %}

                {{ wizard.management_form }}
                {% if wizard.steps.current == 'welcome' %}
                {% elif wizard.steps.current == 'generator' %}
                    {% with wizard.form.token as field %}
                        {% include "admin/includes/text-field.html" %}
                    {% endwith %}
                {% elif wizard.steps.current == 'method' %}
                    {% with wizard.form.method as field %}
                        {% include "admin/includes/text-field.html" %}
                    {% endwith %}
                {% elif wizard.steps.current == 'call' or wizard.steps.current == 'sms' %}
                    {% with wizard.form.number as field %}
                        {% include "admin/includes/text-field.html" %}
                    {% endwith %}
                {% elif wizard.steps.current == 'validation' %}
                    {% with wizard.form.token as field %}
                        {% include "admin/includes/text-field.html" %}
                    {% endwith %}
                {% endif %}
                {# hidden submit button to enable [enter] key #}
                <div style="margin-left: -9999px"><input type="submit" value=""/></div>
            </div>
            <div class="dialog__footer dialog-footer">
                <div class="dialog-footer__actions">
                    <a href="{% url 'account-admin:edit' %}" class="pull-right btn btn--transparent">{% trans "Cancel" %}</a>
                    {% if wizard.steps.prev %}
                      <button name="wizard_goto_step" type="submit"
                              value="{{ wizard.steps.prev }}"
                              class="btn btn-default">{% trans "Back" %}</button>
                    {% endif %}
                    <button type="submit" class="btn btn--primary">{% trans "Next" %}</button>
                </div>
            </div>
        </div>
        <div class="dialog__content dialog__content--post">
            {% if request.user.is_authenticated %}
            <p class="text-center">
                <a href="{% url "account-admin:logout" %}">{% trans "Sign out" %}</a>
            </p>
            {% endif %}
        </div>
    </div>
</form>
{% endblock %}
